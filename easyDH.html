<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proyector Iglesia - Reina Valera Completa (Offline)</title>
  <meta name="theme-color" content="#000000">
  <link rel="manifest" href="data:application/manifest+json,{\"name\":\"Proyector Biblia\",\"short_name\":\"Biblia\",\"start_url\":\".\",\"display\":\"standalone\",\"background_color\":\"#000\",\"theme_color\":\"#000\"}"/>
  <style>
    body {font-family: Arial, sans-serif; margin:0; background:#f4f4f4;}
    #control {max-width:900px; margin:20px auto; padding:20px; background:white; border-radius:10px; box-shadow:0 4px 20px rgba(0,0,0,0.1);}
    input, button {padding:12px; font-size:18px; margin:5px 0; width:100%; border-radius:6px; border:1px solid #ccc;}
    button {background:#0066cc; color:white; border:none; cursor:pointer; font-weight:bold;}
    .btn-proyectar {background:#28a745;}
    .btn-salir {position:fixed; top:10px; right:10px; padding:15px 25px; font-size:30px; background:#dc3545; display:none; z-index:9999;}
    #pantalla {position:fixed; top:0; left:0; width:100vw; height:100vh; background:#000; color:#fff; font-size:6vw; display:flex; align-items:center; justify-content:center; text-align:center; padding:10%; line-height:1.8; display:none; z-index:9998; overflow:auto;}
    .libro {font-size:0.9em; color:#ffcc00; margin-bottom:10px;}
    .versiculo-num {font-size:0.6em; vertical-align:top; color:#888; margin-right:5px;}
    .resultado {margin-top:15px; padding:15px; background:#f9f9f9; border-radius:8px; max-height:400px; overflow-y:auto;}
    .loading {color:#0066cc; font-weight:bold;}
    .error {color:#dc3545;}
  </style>
</head>
<body>

<div id="control">
  <h1 style="text-align:center; color:#0066cc;">Proyector Iglesia - Reina Valera Completa (Offline)</h1>
  <p style="text-align:center;" class="loading" id="status">Cargando Biblia desde tu PC...</p>

  <input type="text" id="buscar" placeholder="Escribe: Juan 3:16 | Salmos 23 | amor | Dios..." autofocus>
  <button onclick="buscar()">Buscar versículo</button>
  <button class="btn-proyectar" onclick="proyectar()">Proyectar (F11 para pantalla completa)</button>

  <div class="resultado" id="resultado"></div>
</div>

<div id="pantalla" onclick="cerrarProyeccion()">
  <div id="contenidoPantalla"></div>
</div>
<button class="btn-salir" onclick="cerrarProyeccion()">✖</button>

<script>
let biblia = {}; // Aquí se cargará todo: { "Génesis 1:1": "En el principio...", ... }

async function cargarBiblia() {
  try {
    // AQUÍ ES DONDE "PEGAS" LA RUTA: Cambia 'biblias/SPA_RV.json' por la ruta exacta en tu carpeta
    const response = await fetch('biblias/SPA_RV.json'); // Si tu archivo se llama diferente, cámbialo aquí
    if (!response.ok) throw new Error('Archivo no encontrado. Verifica la ruta.');
    const data = await response.json();
    
    // El formato de scrollmapper es un array de objetos: [{book_name: "Génesis", chapter:1, verse:1, text: "..."}, ...]
    data.forEach(item => {
      const ref = `${item.book_name} ${item.chapter}:${item.verse}`;
      biblia[ref] = item.text;
      // También guarda en minúsculas para búsquedas fáciles
      biblia[ref.toLowerCase()] = item.text;
    });
    
    document.getElementById("status").textContent = `¡Biblia cargada! ${Object.keys(biblia).length} versículos listos.`;
    document.getElementById("status").className = "";
  } catch (err) {
    document.getElementById("status").textContent = `Error: ${err.message}. Verifica que el archivo SPA_RV.json esté en la carpeta 'biblias/'.`;
    document.getElementById("status").className = "error";
    console.error(err);
  }
}

cargarBiblia(); // Carga automática al abrir

// Funciones de búsqueda (igual que antes, pero adaptadas al formato)
function buscar() {
  const texto = document.getElementById("buscar").value.trim();
  const div = document.getElementById("resultado");
  div.innerHTML = "";

  if (!texto || Object.keys(biblia).length === 0) {
    div.innerHTML = "<strong>Espera a que cargue la Biblia o escribe algo.</strong>";
    return;
  }

  // Búsqueda exacta por referencia (ej: Juan 3:16, salmos 23:1-4)
  const exacta = buscarReferenciaExacta(texto);
  if (exacta && exacta.length > 0) {
    mostrarVersiculos(exacta);
    return;
  }

  // Búsqueda por palabras
  const palabras = texto.toLowerCase().split(" ").filter(p => p.length > 2);
  const resultados = [];
  for (const ref in biblia) {
    const vers = biblia[ref].toLowerCase();
    if (palabras.every(p => vers.includes(p))) {
      resultados.push(ref);
      if (resultados.length >= 50) break; // Límite para velocidad
    }
  }

  if (resultados.length === 0) {
    div.innerHTML = "<strong>No se encontró nada. Prueba con 'Juan 3:16' o 'amor'.</strong>";
  } else {
    mostrarVersiculos(resultados);
  }
}

function buscarReferenciaExacta(refInput) {
  refInput = refInput.trim().toLowerCase();
  let lista = [];
  
  // Soporte para rangos: Salmos 23:1-4
  const rangoMatch = refInput.match(/([a-záéíóúñ\s]+)\s+(\d+):(\d+)-(\d+)/i);
  if (rangoMatch) {
    const libroCap = rangoMatch[1].trim() + " " + rangoMatch[2];
    const desde = parseInt(rangoMatch[3]);
    const hasta = parseInt(rangoMatch[4]);
    for (let v = desde; v <= hasta; v++) {
      const clave = `${libroCap}:${v}`;
      if (biblia[clave.toLowerCase()]) lista.push(clave);
    }
    return lista;
  }
  
  // Búsqueda exacta simple: Juan 3:16
  const simpleMatch = refInput.match(/([a-záéíóúñ\s]+)\s+(\d+):(\d+)/i);
  if (simpleMatch) {
    const clave = `${simpleMatch[1].trim()} ${simpleMatch[2]}:${simpleMatch[3]}`;
    if (biblia[clave.toLowerCase()]) return [clave];
  }
  
  // Búsqueda por capítulo completo: Salmos 23
  const capMatch = refInput.match(/([a-záéíóúñ\s]+)\s+(\d+)/i);
  if (capMatch) {
    const libro = capMatch[1].trim();
    const cap = parseInt(capMatch[2]);
    for (let v = 1; v <= 50; v++) { // Asume máx 50 versos por cap
      const clave = `${libro} ${cap}:${v}`;
      if (biblia[clave.toLowerCase()]) lista.push(clave);
      else break;
    }
    if (lista.length > 0) return lista;
  }
  
  return [];
}

function mostrarVersiculos(listaRefs) {
  const div = document.getElementById("resultado");
  let html = "";
  listaRefs.forEach(ref => {
    const texto = biblia[ref.toLowerCase()];
    const versNum = ref.split(":")[1];
    html += `<div style="cursor:pointer; padding:10px; margin:8px 0; background:#e9f5ff; border-radius:6px;" onclick="proyectarRef('${ref}')">
               <strong>${ref}</strong><br>
               <span class="versiculo-num">${versNum}</span>${texto}
             </div>`;
  });
  div.innerHTML = html;
}

function proyectarRef(ref) {
  const texto = biblia[ref.toLowerCase()];
  const libroCap = ref.split(":")[0];
  const vers = ref.split(":")[1];
  const html = `<div class="libro">${libroCap}</div>
                <div><span class="versiculo-num">${vers}</span> ${texto}</div>`;
  document.getElementById("contenidoPantalla").innerHTML = html;
  document.getElementById("pantalla").style.display = "flex";
  document.querySelector(".btn-salir").style.display = "block";
}

function proyectar() {
  const contenido = document.getElementById("resultado").innerHTML;
  if (contenido) {
    document.getElementById("contenidoPantalla").innerHTML = contenido;
    document.getElementById("pantalla").style.display = "flex";
    document.querySelector(".btn-salir").style.display = "block";
  }
}

function cerrarProyeccion() {
  document.getElementById("pantalla").style.display = "none";
  document.querySelector(".btn-salir").style.display = "none";
}

// Enter para buscar
document.getElementById("buscar").addEventListener("keypress", e => { if (e.key === "Enter") buscar(); });
</script>

<div style="text-align:center; margin:30px; color:#666; font-size:14px;">
  Fuente: scrollmapper/bible_databases (Reina-Valera 1909)<br>
  ¡Ya tienes todo offline! Próximo: agregar canciones de EasyWorship.
</div>

</body>
</html>
