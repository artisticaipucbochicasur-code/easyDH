<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proyector Iglesia - Reina Valera Completa</title>
  <meta name="theme-color" content="#000000">
  <link rel="manifest" href="data:application/manifest+json,{\"name\":\"Proyector Biblia\",\"short_name\":\"Biblia\",\"start_url\":\".\",\"display\":\"standalone\",\"background_color\":\"#000\",\"theme_color\":\"#000\"}"/>
  <style>
    body {font-family: Arial, sans-serif; margin:0; background:#f4f4f4;}
    #control {max-width:900px; margin:20px auto; padding:20px; background:white; border-radius:10px; box-shadow:0 4px 20px rgba(0,0,0,0.1);}
    input, button {padding:12px; font-size:18px; margin:5px 0; width:100%; border-radius:6px; border:1px solid #ccc;}
    button {background:#0066cc; color:white; border:none; cursor:pointer; font-weight:bold;}
    .btn-proyectar {background:#28a745;}
    .btn-salir {position:fixed; top:10px; right:10px; padding:15px 25px; font-size:30px; background:#dc3545; display:none; z-index:9999;}
    #pantalla {position:fixed; top:0; left:0; width:100vw; height:100vh; background:#000; color:#fff; font-size:6vw; display:flex; align-items:center; justify-content:center; text-align:center; padding:10%; line-height:1.8; display:none; z-index:9998; overflow:auto;}
    .libro {font-size:0.9em; color:#ffcc00; margin-bottom:10px;}
    .versiculo-num {font-size:0.6em; vertical-align:top; color:#888; margin-right:5px;}
    .resultado {margin-top:15px; padding:15px; background:#f9f9f9; border-radius:8px; max-height:400px; overflow-y:auto;}
    .loading {color:#0066cc; font-weight:bold;}
  </style>
</head>
<body>

<div id="control">
  <h1 style="text-align:center; color:#0066cc;">Proyector Iglesia - Reina Valera Completa</h1>
  <p style="text-align:center;" class="loading" id="status">Cargando toda la Biblia (31 102 versículos) desde GitHub...</p>

  <input type="text" id="buscar" placeholder="Escribe referencia (Juan 3:16) o palabras..." autofocus>
  <button onclick="buscar()">Buscar versículo</button>
  <button class="btn-proyectar" onclick="proyectar()">Proyectar (F11 para pantalla completa)</button>

  <div class="resultado" id="resultado"></div>
</div>

<div id="pantalla" onclick="cerrarProyeccion()">
  <div id="contenidoPantalla"></div>
</div>
<button class="btn-salir" onclick="cerrarProyeccion()">✖</button>

<script>
// ==== CARGAMOS LA BIBLIA COMPLETA DIRECTO DEL REPOSITORIO SCROLLMAPPER ====
let biblia = {};  // Aquí quedará todo: { "Génesis 1:1": "En el principio...", ... }

fetch("https://raw.githubusercontent.com/scrollmapper/bible_databases/master/json/es/SPA_RV1909.json")
  .then(r => r.json())
  .then(data => {
    // El formato del archivo es un array de objetos → lo convertimos a referencia:texto
    data.forEach(item => {
      const ref = `${item.book_name} ${item.chapter}:${item.verse}`;
      biblia[ref] = item.text;
      biblia[ref.toLowerCase()] = item.text; // para búsquedas sin importar mayúsculas
    });
    document.getElementById("status").textContent = "¡Biblia cargada! 31 102 versículos listos.";
    document.getElementById("status").style.color = "#28a745";
  })
  .catch(err => {
    document.getElementById("status").textContent = "Error de internet. Prueba más tarde.";
    console.error(err);
  });

// Búsqueda
function buscar() {
  const texto = document.getElementById("buscar").value.trim();
  const div = document.getElementById("resultado");
  div.innerHTML = "";

  if (!texto) return;

  // Búsqueda exacta por referencia (ej: Juan 3:16 o salmos 23:1-6)
  const exacta = buscarReferenciaExacta(texto);
  if (exacta) {
    mostrarVersiculos(exacta);
    return;
  }

  // Búsqueda por palabras
  const palabras = texto.toLowerCase().split(" ").filter(p => p.length > 2);
  const resultados = [];

  for (const ref in biblia) {
    const vers = biblia[ref].toLowerCase();
    if (palabras.every(p => vers.includes(p))) {
      resultados.push(ref.toUpperCase());
      if (resultados.length >= 50) break; // límite para no colgar
    }
  }

  if (resultados.length === 0) {
    div.innerHTML = "<strong>No se encontró nada</strong>";
  } else {
    mostrarVersiculos(resultados);
  }
}

function buscarReferenciaExacta(ref) {
  ref = ref.trim();
  // Soporta: Juan 3:16  |  salmos 23  |  Salmo 23:1-6  |  Génesis 1
  const normalizada = ref.replace(/ de /g," ").replace(/é/g,"e").toLowerCase();
  const encontrado = Object.keys(biblia).find(k => k.toLowerCase().includes(normalizada));
  if (encontrado) return [encontrado.toUpperCase()];

  // Rango tipo Salmos 23:1-6
  const rango = ref.match(/(.+?)\s+(\d+):(\d+)-(\d+)/i);
  if (rango) {
    const libroCap = rango[1] + " " + rango[2];
    const desde = parseInt(rango[3]);
    const hasta = parseInt(rango[4]);
    const lista = [];
    for (let v=desde; v<=hasta; v++) {
      const clave = `${libroCap}:${v}`.toUpperCase();
      if (biblia[clave.toLowerCase()]) lista.push(clave);
    }
    return lista.length > 0 ? lista : null;
  }
  return null;
}

function mostrarVersiculos(listaRefs) {
  const div = document.getElementById("resultado");
  let html = "";
  listaRefs.forEach(ref => {
    const texto = biblia[ref.toLowerCase()] || biblia[ref];
    const numero = ref.split(":")[1];
    html += `<div style="cursor:pointer; padding:10px; margin:8px 0; background:#e9f5ff; border-radius:6px;" onclick="proyectarRef('${ref}')">
               <strong>${ref}</strong><br>
               <span>${texto}</span>
             </div>`;
  });
  div.innerHTML = html;
}

function proyectarRef(ref) {
  const texto = biblia[ref.toLowerCase()] || biblia[ref];
  const html = `<div class="libro">${ref.split(" ")[0]} ${ref.split(" ")[1]}</div>
                <div><span class="versiculo-num">${ref.split(":")[1]}</span> ${texto}</div>`;
  document.getElementById("contenidoPantalla").innerHTML = html;
  document.getElementById("pantalla").style.display = "flex";
  document.querySelector(".btn-salir").style.display = "block";
}

function proyectar() {
  const contenido = document.getElementById("resultado").innerHTML;
  if (contenido) {
    document.getElementById("contenidoPantalla").innerHTML = contenido;
    document.getElementById("pantalla").style.display = "flex";
    document.querySelector(".btn-salir").style.display = "block";
  }
}

function cerrarProyeccion() {
  document.getElementById("pantalla").style.display = "none";
  document.querySelector(".btn-salir").style.display = "none";
}

// Enter en el input = buscar
document.getElementById("buscar").addEventListener("keypress", e => { if (e.key === "Enter") buscar(); });
</script>

<div style="text-align:center; margin:30px; color:#666; font-size:14px;">
  Biblia: Reina-Valera 1909 (scrollmapper/bible_databases)<br>
  Funciona 100% offline después de la primera carga<br>
  Próximo paso → añadir tus canciones y coros favoritos
</div>

</body>
</html>
